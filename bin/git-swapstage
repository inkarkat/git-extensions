#!/bin/bash
# Source: https://stackoverflow.com/a/20458127/813602

printUsage()
{
    cat <<HELPTEXT
Swap staged and unstaged (just updated; pass -A|--all to also include untracked
files) changes.
HELPTEXT
    printf 'Usage: %q %s\n' "$(basename "$1")" '[-A|--all] [-?|-h|--help]'
}
uncommit()
{
    git reset HEAD~1 || exit $?
    git reset HEAD~1 --soft || exit $?
}

addArg=--update
while [ $# -ne 0 ]
do
    case "$1" in
	--help|-h|-\?)	shift; printUsage "$0"; exit 0;;
	--no-color|--color=*)
			shift;;
	--color)	shift; shift;;
	--continue)	uncommit; exit $?;;
	--all)		addArg="$1"; shift;;
	--)		shift; break;;
	-*)		{ echo "ERROR: Unknown option \"$1\"!"; echo; printUsage "$0"; } >&2; exit 2;;
	*)		break;;
    esac
done
if [ $# -ne 0 ]; then
    printUsage "$0" >&2
    exit 2
elif git-existsbr _invert; then
    echo >&2 'ERROR: It looks like a git-swaplast is under way. Please finalize that first (via --continue|--quit|--abort|--cleanup).'
    exit 1
fi

git commit -m futureUnstaged || exit $?
git add $addArg || exit $?
git commit -m futureStage || exit $?
git swaplast || { status=$?; printf >&2 'hint: after swapping, finish the inversion with %q --continue\n' "$(basename "$0")"; exit $status; }
uncommit
