#!/bin/bash
set -o pipefail

printUsage()
{
    command hub pr --help 2>&1 | sed \
	-e '/\[-f$/{ N; s/\n[[:space:]]*/ /; }' \
	-e 's/\[-f FORMAT\]/[--age|-v|--verbose|--browse|-f|--format FORMAT]/g'
}

typeset -a colorArg=(--color=always)
typeset -a pager=("${PAGER:-less}" --RAW-CONTROL-CHARS)
typeset -a defaultFormatter=(column -s $'\t' -t)
if [ ! -t 1 ]; then
    colorArg=()
    pager=()
    defaultFormatter=()
fi
action=pullRequestList
format=
defaultFormat='%pC%>(8)%i%Creset  %t%  l%n'
issueFormatEmulation='%sC%>(8)%i%Creset  %t%  l'
typeset -a formatter=()
typeset -a args=()
while [ $# -ne 0 ]
do
    case "$1" in
	--help|-h|-\?)	shift; printUsage "$0"; exit 0;;
	--color=auto)	shift;;
	--no-color)	colorArg=(--color=never); shift;; # XXX: --no-color is not supported by hub
	--color=*)	colorArg=("$1"); shift;;
	--color)	[ "$2" = auto ] || colorArg=("$1" "$2"); shift; shift;;
	checkout|show)	action="command hub pr $1"; shift; pager=();;
	--format|-f)	shift; format="${1:?}"; shift;;
	--assignee=*|--creator=*|--mentioned=*)
			args+=("$1"); shift; action=pullRequestsFromIssues;;
	--browse)	shift; defaultFormat='%U%n'; issueFormatEmulation='%U'; formatter=(linesToArgs git-browse);;
	--verbose|-v)	shift; defaultFormat="${defaultFormat/  /  %Ccyan%H%Creset â†’ %Cblue%B%Creset	}"; formatter=("${defaultFormatter[@]}");;
	--age)		shift; defaultFormat="${defaultFormat/  /  %cI	(%cr)	}"; issueFormatEmulation="${issueFormatEmulation/  / %cI	(%cr)	}"; formatter=("${defaultFormatter[@]}");;
	--)		args+=("$1"); shift; break;;
	*)		args+=("$1"); shift;;
    esac
done
set -- "${args[@]}" "$@"


pullRequestsFromIssues()
{
    # XXX: hub pr (in version 2.14.2) cannot filter yet, but we can misuse hub
    # issue for it (with filtering). Unfortunately, that means that certain
    # format placeholders (like %B) are not available.
    if [ -n "$format" ]; then
	echo >&2 'ERROR: Cannot use -f|--format here.'
	exit 2
    fi

    filterPullRequestsFromUrlInFieldOne()
    {
	sed -e 's#^[^\t]\+/pull/[^\t]\+\t\(.*\)$#\1#' -e t -e 'd'
    }

    command hub issue --include-pulls --format "%U	${format:-$issueFormatEmulation}%n" "${colorArg[@]}" "$@" \
	| eval filterPullRequestsFromUrlInFieldOne
}

pullRequestList()
{
    # XXX: hub pr (in version 2.14.2) does not default to "list" (like hub issue)
    # . DWIM and add this.
    typeset -a defaultAction=()
    [ $# -eq 0 -o "${1:0:1}" != - ] \
	&& defaultAction=(list)

    command hub pr "${defaultAction[@]}" --format "${format:-$defaultFormat}" "${colorArg[@]}" "$@"
}

eval '$action "$@"' \
    "${formatter:+|}" '"${formatter[@]}"' \
    "${pager:+|}" '"${pager[@]}"'
