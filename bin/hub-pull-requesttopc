#!/bin/bash

typeset -a branchArgs=()
typeset -a pullrequestArgs=()
typeset -a allargs=()
while [ $# -ne 0 ]
do
    case "$1" in
	--help|-h|-\?)	shift; printUsage "$0"; exit 0;;
	--branch|-b)	branchArgs+=("$1" "${2:?}"); pullrequestArgs+=(--head "${2:?}"); shift; shift;;
	--)		allargs+=("$1"); shift; break;;
	*)		allargs+=("$1"); shift;;
    esac
done
set -- "${allargs[@]}" "$@"

# DWIM: Add reference to a pull request of the previous cloned branch if such
# exists. I use cloned branches to build changes on top of each other, and these
# are then rebased and merged in turn.
previousClonedPr="$(git clonedbranch-command --offset -1 "${branchArgs[@]}" -3 prtitle --only-ids BRANCH)"
if [ -n "$previousClonedPr" ]; then
    contains --no-edit "$@" || pullrequestArgs+=(--edit)
    pullrequestArgs+=(--message "* Note: This is a follow-up on $previousClonedPr")
fi

exec git-rev-range-to-previous-clone --no-range "${branchArgs[@]}" --keep-position "${HUB_PULLREQUESTTO_COMMAND:-pull-request}" --base RANGE "${pullrequestArgs[@]}" "$@"
